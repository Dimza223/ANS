#1. (15) Најавете се на машината со која е асоциран вашиот број на индекс. Корисничко име за
#најава student, лозинка Laboratorija11!
#Направете нов корисник со име ansXXXXXX, каде XXXXXX е вашиот број на индекс. Направете група
#ans и додадете го тој корисник во групата. Како hostname на вашата виртуелка наместете ansdatum, каде datum е вашиот датум на раѓање во облик ddmmyyyy.

#Креирање корисник
useradd ans232117
passwd ans232117

#Креирање група и додавање корисник
groupadd ans
usermod -aG ans ans232117

#Поставување hostname
hostnamectl set-hostname ans27102004
hostname

#2. (20) Инсталирајте BIND DNS сервер, и додадете го како прв локален dns сервер на машината.
#Допуштете да може да се пристапи до него (да се користи како DNS) од било која машина во
#мрежата 10.10.0.0/16. Креирајте нова master зона согласно името index.io.mk, каде што index е
#бројот на вашиот индекс. Во зоната додадете ги следните записи:
#- NS сервери се вашиот сервер и серверот ns.ans.mk, кој има IP адреса 10.10.16.200
#- A записи за ns1, www и ftp2 кои ќе покажуваат кон вашиот сервер
#- A запис за dns, кој ќе покажува кон 10.10.16.200
#- CNAME запис за web, кој ќе покажува кон www.index.io.mk
#Овозможете forwarding-от на барањата до вашиот DNS server за зони за кои не може да одговори
#да бидат проследувани до DNS серверите 1.0.0.1 и 1.1.1.1.

#Инсталација
dnf install bind bind-utils -y

#Конфигурација /etc/named.conf
nano /etc/named.conf

------------------------------

listen-on port 53 { any; };
allow-query { 10.10.0.0/16; };
recursion yes;

forwarders {
    1.0.0.1;
    1.1.1.1;
};

------------------------------

zone "232117.io.mk" IN {
    type master;
    file "232117.io.mk.zone";
};

------------------------------

#Креирање зона датотека
nano /var/named/232117.io.mk.zone

------------------------------

$TTL 86400
@   IN  SOA ns1.232117.io.mk. root.232117.io.mk. (
        2024011501
        3600
        1800
        604800
        86400
)

@       IN  NS  ns1.232117.io.mk.
@       IN  NS  ns.ans.mk.

ns1     IN  A   <IP_НА_ВАШИОТ_СЕРВЕР>
www     IN  A   <IP_НА_ВАШИОТ_СЕРВЕР>
ftp2    IN  A   <IP_НА_ВАШИОТ_СЕРВЕР>
dns     IN  A   10.10.16.200
web     IN  CNAME www.232117.io.mk.

------------------------------

#Пермисии
chown root:named /var/named/232117.io.mk.zone
chmod 640 /var/named/232117.io.mk.zone

#Проверка
named-checkconf
named-checkzone 232117.io.mk /var/named/232117.io.mk.zone
systemctl restart named
systemctl status named --no-pager


#Старт и enable
systemctl restart named
systemctl enable --now named


#3. (10) Инсталирајте apache веб сервер.
dnf install httpd -y
systemctl enable --now httpd

#3. (10) Инсталирајте nginx веб сервер.
dnf install epel-release -y
dnf install nginx -y
systemctl enable --now nginx
systemctl status nginx --no-pager
firewall-cmd --permanent --add-service=http
firewall-cmd --reload


#4. (20) Инсталирајте последна стабилна верзија од Moodle во сервер блок со виртуелен хост IP
#адресата на серверот и порта 8088. Инсталирајте и конфигурирајте ги сите апликации, екстензии и
#сервери потребни за да проработи сајтот. Верзијата на php треба да биде тековната
#(стандардната) за вашиот сервер.

#PHP + екстензии
dnf install php php-cli php-mysqlnd php-xml php-gd php-intl php-mbstring php-soap php-zip -y

#MySQL (MariaDB)
dnf install mariadb-server -y
systemctl enable --now mariadb
mysql_secure_installation

#Креирање база
mysql -u root -p
CREATE DATABASE moodle;
CREATE USER 'moodle'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON moodle.* TO 'moodle'@'localhost';
FLUSH PRIVILEGES;
EXIT;

#Преземање Moodle
cd /var/www/
wget https://download.moodle.org/download.php/direct/stable402/moodle-4.2.4.tgz
tar -xzf moodle-4.2.4.tgz
ls(Провери за moodle-4.2.4.tgz и moodle/ )

mkdir /var/moodledata
chown -R apache:apache /var/www/moodle /var/moodledata
chmod -R 755 /var/moodledata

#VirtualHost (порт 8088)
nano /etc/httpd/conf.d/moodle.conf

-----------------------------------

Listen 8088

<VirtualHost *:8088>
    DocumentRoot /var/www/moodle
    <Directory /var/www/moodle>
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

-----------------------------------

systemctl restart httpd

#Dozvola za apache da slusa na porta 8088(Ako Restart pravi problem)
sudo semanage port -a -t http_port_t -p tcp 8088
-Proverka
semanage port -l | grep http_port_t

#(25) Инсталирајте последна стабилна верзија од Wordpress во сервер блок со виртуелен хост #index.anms.com.mk (index – е вашиот индекс). Инсталирајте и конфигурирајте ги сите апликации, #екстензии и сервери #потребни за да проработи сајтот.

#Install required packages (Apache, PHP, MariaDB)
dnf install httpd mariadb-server php php-mysqlnd php-gd php-xml php-mbstring php-json php-curl php-zip -y


#Start & enable services
systemctl enable --now httpd
systemctl enable --now mariadb

#Secure MariaDB and create WordPress database
mysql_secure_installation
mysql -u root -p

#Create database & user
CREATE DATABASE wordpress;
CREATE USER 'wpuser'@'localhost' IDENTIFIED BY 'StrongPass123!';
GRANT ALL PRIVILEGES ON wordpress.* TO 'wpuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;

#3️ Download and extract latest stable WordPress
cd /var/www
wget https://wordpress.org/latest.tar.gz
tar -xzf latest.tar.gz

#Set ownership
chown -R apache:apache /var/www/wordpress
chmod -R 755 /var/www/wordpress

#Configure Apache VirtualHost

#Create vhost config
nano /etc/httpd/conf.d/232117.ans.com.mk.conf

---------------------------------------------

<VirtualHost *:80>
    ServerName 232117.ans.com.mk
    DocumentRoot /var/www/wordpress

    <Directory /var/www/wordpress>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog /var/log/httpd/index_error.log
    CustomLog /var/log/httpd/index_access.log combined
</VirtualHost>

-------------------------------------------------

#Test & restart Apache
apachectl configtest
systemctl restart httpd

#SELinux fixes (VERY IMPORTANT on Rocky)
setsebool -P httpd_can_network_connect on
setsebool -P httpd_can_network_connect_db on
semanage fcontext -a -t httpd_sys_rw_content_t "/var/www/wordpress(/.*)?"
restorecon -Rv /var/www/wordpress

#Firewall (if enabled)
firewall-cmd --permanent --add-service=http
firewall-cmd --reload

#5. (15) Инсталирајте NFS клиент. Креирајте директориуми за маунтирање /nfs/jan2024 и
#/nfs/proba2024. Маунтирајте ги следните nfs фолдери од nfs серверот на 10.10.16.200:
#- /mnt/kolokvium_2024 на /nfs/jan2024
#- /mnt/proba на /nfs/proba2024
#Додадете ги точките за маунтирање во /etc/fstab, за да може да се пристапат и после
#рестартирање на машината. Во /nfs/jan2024 креирајте ваш фолдер со име на индекс и внатре
#креирајте празна датотека со име по ваш избор.

#Инсталација
dnf install nfs-utils -y

#Креирање Директориуми
mkdir -p /nfs/jan2024 /nfs/proba2024

#Маунтирање
mount 10.10.16.200:/mnt/kolokvium_2024 /nfs/jan2024
mount 10.10.16.200:/mnt/proba /nfs/proba2024

#/etc/fstab
nano /etc/fstab
---------------
10.10.16.200:/mnt/kolokvium_2024 /nfs/jan2024 nfs defaults 0 0
10.10.16.200:/mnt/proba /nfs/proba2024 nfs defaults 0 0
---------------

#Креирање фолдер и фајл
mkdir /nfs/jan2024/232117
touch /nfs/jan2024/232117/test.txt

#5. (15) Инсталирајте FTP со корисник editor кој ќе има привилегии за читање и запишување на
#поддиректориумот ftp во фолдерот /home/student. Фолдерот ftp треба да се креира доколку не
#постои. 

#Инсталација на FTP сервер (vsftpd) и FTP
dnf install vsftpd -y
dnf install ftp -y

#Активирање:
systemctl enable --now vsftpd

#Провери
systemctl status vsftpd --no-pager


#Креирање на директориум /home/student/ftp
mkdir -p /home/student/ftp

#Креирање корисник editor
useradd editor
passwd editor

#Дозволи
chown editor:editor /home/student/ftp

#Постави пермисии
chmod 755 /home/student/ftp

#Конфигурација на vsftpd(Dodaj to sho falit)
nano /etc/vsftpd/vsftpd.conf

-----------------------------
anonymous_enable=NO
local_enable=YES
write_enable=YES

chroot_local_user=YES
allow_writeable_chroot=YES

local_root=/home/student/ftp
-----------------------------

#Рестартирање на FTP сервисот
systemctl restart vsftpd

#Firewall
firewall-cmd --permanent --add-service=ftp
firewall-cmd --reload

#Firewall
ftp localhost

Name: editor
Password: ****
----------------
Пробај
pwd
put test.txt
ls
----------------


#5. (25) Инсталирајте FTP со корисник editor кој ќе има привилегии за читање и запишување на
#wordpress директориумот.

#Инсталација на FTP сервер (vsftpd) и FTP
dnf install vsftpd -y
dnf install ftp -y

#Активирање:
systemctl enable --now vsftpd

#Провери
systemctl status vsftpd --no-pager

#Креирање корисник editor
useradd editor
passwd editor

#ЧЕКОР 3: Доделување пристап до WordPress директориумот
ls -ld /var/www/wordpress

#Промена на сопственост (клучно за write пристап)
chown -R editor:editor /var/www/wordpress

#Пермисии
chmod -R 755 /var/www/wordpress

#Конфигурација на vsftpd
nano /etc/vsftpd/vsftpd.conf
----------------------------
anonymous_enable=NO
local_enable=YES
write_enable=YES

chroot_local_user=YES
allow_writeable_chroot=YES
---------------------------

#Дозволи FTP write преку SELinux
setsebool -P ftpd_full_access on

#Дозволи FTP да пишува во web директориум
setsebool -P allow_ftpd_full_access on

#Постави SELinux контекст на WordPress
semanage fcontext -a -t public_content_rw_t "/var/www/wordpress(/.*)?"
restorecon -Rv /var/www/wordpress

#Firewall
firewall-cmd --permanent --add-service=ftp
firewall-cmd --reload

#ЧЕКОР 7: Рестартирање на FTP сервисот
systemctl restart vsftpd

ЧЕКОР 8: Тестирање (колоквиумски доказ)
ftp localhost

user: editor
password: ****

---------------------
cd /var/www/wordpress
put test.txt
ls
---------------------

#7.Инсталирај и конфигурирај firewalld(SSH,DNS,HTTP/HTTPS,FTP или NFS и портата за инсталираниот
# Moodle/WordPress сајт),со соодветни протоколи и порти.

systemctl enable --now firewalld

firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=dns
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-service=ftp
firewall-cmd --permanent --add-port=8088/tcp
firewall-cmd --reload

firewall-cmd --list-all

#8.Прикажи ги сите firewalld команди во iptables

iptables -F

iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
iptables -A INPUT -p tcp --dport 21 -j ACCEPT
iptables -A INPUT -p tcp --dport 8088 -j ACCEPT

iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT



MISSING(nano,wget,semanage)
semanage:
dnf install policycoreutils-python-utils -y
wget:
dnf install policycoreutils-python-utils -y
nano:
dnf install nano -y


